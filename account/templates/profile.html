{% extends 'base.html' %}

{% block content %}
<div class="card">
    <div class="card-header text-center">
        <h2 id="profile-header">Profile</h2>
    </div>
    <div class="card-body">
        <div class="row">
            <!-- Profile Picture Column -->
            <div class="col-md-4 text-center">
                <img id="profile-picture" class="rounded-circle img-fluid" alt="Profile Picture" style="display: none;">
            </div>
            <!-- Profile Information Column -->
            <div class="col-md-8">
                <p><strong>Username:</strong> <span id="profile-username"></span></p>
                <p><strong>Role:</strong> <span id="profile-role"></span></p>
                <p><strong>Bio:</strong> <span id="profile-bio"></span></p>
                <p id="profile-phone-number" style="display: none;"><strong>Phone Number:</strong> <span></span></p>
                <p id="profile-website" style="display: none;"><strong>Organisation Website:</strong> <span></span></p>
                <p><strong>Direct Messages Open:</strong> <span id="profile-dm-open"></span></p>
                <p><strong>Do I require assistance?</strong> <span id="profile-needs-help"></span></p>
            </div>
        </div>
        <!-- Financial Profile Section -->
        <div id="financial-profile" class="mt-4" style="display: none;">
            <h3>Financial Profile</h3>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Own Income:</strong> <span id="profile-own-income"></span></p>
                    <p><strong>Employment Status:</strong> <span id="profile-employment-status"></span></p>
                    <p><strong>Housing Status:</strong> <span id="profile-housing-status"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>Household Income:</strong> <span id="profile-household-income"></span></p>
                    <p><strong>Household Members:</strong> <span id="profile-household-members"></span></p>
                    <p><strong>Per Capita Income:</strong> <span id="profile-per-capita-income"></span></p>
                    <p><strong>Lives with Elderly?:</strong> <span id="profile-has-elderly"></span></p>
                    <p><strong>Lives with Children?:</strong> <span id="profile-has-children"></span></p>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Profile Button (conditional) -->
    <div class="card-footer text-center">
        {% if is_own %}
        <a href="{% url 'edit_profile' %}" class="btn btn-primary">Edit Profile</a>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const profileContainer = document.getElementById("profile-container");
        const profileHeader = document.getElementById("profile-header");
        const profileUsername = document.getElementById("profile-username");
        const profileRole = document.getElementById("profile-role");
        const profileBio = document.getElementById("profile-bio");
        const profilePhoneNumber = document.getElementById("profile-phone-number");
        const profileWebsite = document.getElementById("profile-website");
        const profileDmOpen = document.getElementById("profile-dm-open");
        const profileNeedsHelp = document.getElementById("profile-needs-help");
        const profilePCI = document.getElementById("profile-per-capita-income");
        const profileElderly = document.getElementById("profile-has-elderly");
        const profileChildren = document.getElementById("profile-has-children");
        const profilePicture = document.getElementById("profile-picture");
        const editProfileBtn = document.getElementById("edit-profile-btn");

        // Fetch the profile data
        fetch('{{api_url}}', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then((response) => {
            if (!response.ok) {
                throw new Error("Failed to load profile data.");
            }
            return response.json();
        })
        .then((data) => {
            console.log(data)
            profileHeader.textContent = `${data.username}'s Profile`;
            profileUsername.textContent = data.username;
            profileRole.textContent = data.role;
            profileBio.textContent = data.bio || "No bio available.";
            profileDmOpen.textContent = data.is_dm_open ? "Yes" : "No";
            profileNeedsHelp.textContent = data.needs_help ? "Yes" : "No";

            if (data.profile_picture) {
                profilePicture.src = data.profile_picture;
                profilePicture.style.display = "block";
            }

            if (data.phone_number) {
                profilePhoneNumber.querySelector("span").textContent = data.phone_number;
                profilePhoneNumber.style.display = "block";
            }

            if (data.role === "Organisation" && data.website) {
                profileWebsite.querySelector("span").textContent = data.website;
                profileWebsite.style.display = "block";
            }
            if (data.needs_help && data.financial_profile) {
                document.getElementById("profile-own-income").textContent = `$${data.financial_profile.own_income || "N/A"}`;
                document.getElementById("profile-household-income").textContent = `$${data.financial_profile.household_income || "N/A"}`;
                document.getElementById("profile-household-members").textContent = data.financial_profile.household_members || "N/A";
                document.getElementById("profile-employment-status").textContent = data.financial_profile.employment_status || "N/A";
                document.getElementById("profile-housing-status").textContent = data.financial_profile.housing_status || "N/A";
                profileElderly.textContent = data.financial_profile.has_elderly ? "Yes" : "No";
                profileChildren.textContent = data.financial_profile.has_children ? "Yes" : "No";
                if (data.financial_profile.household_income && data.financial_profile.household_members && data.financial_profile.household_members > 0) {
                    let perCapitaIncome = data.financial_profile.household_income / data.financial_profile.household_members;
                    document.getElementById("profile-per-capita-income").textContent = `$${perCapitaIncome.toFixed(2)}`;
                } else {
                    document.getElementById("profile-per-capita-income").textContent = "N/A";
                }


                document.getElementById("financial-profile").style.display = "block";
            }
        })
        .catch((error) => {
            profileContainer.textContent = "Error loading profile.";
            console.error(error);
        });
    });
</script>
{% endblock %}